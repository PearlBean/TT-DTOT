<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H·ªá th·ªëng gi√°m s√°t ph∆∞∆°ng ti·ªán th√¥ng minh</title>

    <!-- SDK (n·∫øu b·∫°n d√πng trong m√¥i tr∆∞·ªùng Element) -->
    <script src="/_sdk/element_sdk.js"></script>
    <script src="/_sdk/data_sdk.js"></script>

    <!-- Tailwind + Chart.js + Leaflet -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      /* Gi·ªØ chi·ªÅu cao c·ªë ƒë·ªãnh cho bi·ªÉu ƒë·ªì l·ªãch s·ª≠ */
      #historyChart {
        position: relative;
        height: 24rem;
      }

      #historyChart canvas {
        width: 100% !important;
        height: 100% !important;
      }

      body {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f0f4f8;
        height: 100%;
      }

      html {
        height: 100%;
      }

      .sidebar {
        background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      }

      .nav-item {
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .nav-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
      }

      .nav-item.active {
        background: rgba(255, 255, 255, 0.15);
        border-left: 4px solid #60a5fa;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      }

      .chart-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 20px;
      }

      .pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .btn-primary {
        background: #2563eb;
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s ease;
      }

      .btn-primary:hover {
        background: #1d4ed8;
      }

      .form-input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        transition: border 0.2s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #2563eb;
      }

      .login-container {
        min-height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .login-box {
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 90%;
      }

      .alert-item {
        background: white;
        border-left: 4px solid #ef4444;
        padding: 16px;
        margin-bottom: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
      }

      .loading-spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #2563eb;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
  </head>

  <body>
    <!-- LOGIN -->
    <div id="loginPage" class="login-container">
      <div class="login-box">
        <div class="text-center mb-8">
          <div class="text-5xl mb-4">üöó</div>
          <h1 id="systemTitle" class="text-3xl font-bold text-gray-800 mb-2">
            Gi√°m s√°t xe c·ªßa t√¥i
          </h1>
          <p class="text-gray-600">Theo d√µi t·ªëc ƒë·ªô v√† √°p su·∫•t l·ªëp xe</p>
        </div>
        <form id="loginForm" class="space-y-4">
          <div>
            <label
              for="loginUsername"
              class="block text-sm font-semibold text-gray-700 mb-2"
              >T√†i kho·∫£n</label
            >
            <input
              type="text"
              id="loginUsername"
              class="form-input"
              placeholder="Nh·∫≠p t√†i kho·∫£n"
              required
            />

            <label
              for="loginPassword"
              class="block text-sm font-semibold text-gray-700 mb-2 mt-4"
              >M·∫≠t kh·∫©u</label
            >
            <input
              type="password"
              id="loginPassword"
              class="form-input"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
          </div>
          <button type="submit" class="btn-primary w-full">ƒêƒÉng nh·∫≠p</button>
        </form>
      </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display: none; height: 100%">
      <div class="flex" style="height: 100%">
        <!-- SIDEBAR -->
        <div class="sidebar w-64 text-white flex-shrink-0 relative">
          <div class="p-6">
            <div class="text-2xl font-bold mb-2">üöó Xe c·ªßa t√¥i</div>
            <p class="text-sm text-blue-200">Theo d√µi th·ªùi gian th·ª±c</p>
          </div>
          <nav class="mt-6">
            <div
              class="nav-item active px-6 py-3 flex items-center space-x-3"
              data-page="dashboard"
            >
              <span class="text-xl">üìä</span>
              <span class="font-semibold">T·ªïng quan</span>
            </div>
            <div
              class="nav-item px-6 py-3 flex items-center space-x-3"
              data-page="history"
            >
              <span class="text-xl">üìà</span>
              <span class="font-semibold">L·ªãch s·ª≠</span>
            </div>
            <div
              class="nav-item px-6 py-3 flex items-center space-x-3"
              data-page="alerts"
            >
              <span class="text-xl">‚ö†Ô∏è</span>
              <span class="font-semibold">C·∫£nh b√°o</span>
            </div>
          </nav>

          <div class="absolute bottom-0 w-64 p-6 border-t border-blue-700">
            <div class="flex items-center space-x-3">
              <div
                class="w-10 h-10 bg-blue-300 rounded-full flex items-center justify-center text-blue-900 font-bold"
              >
                N
              </div>
              <div>
                <div class="font-semibold">TeNguSi</div>
                <button
                  id="logoutBtn"
                  class="text-xs text-blue-200 hover:underline"
                >
                  ƒêƒÉng xu·∫•t
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- CONTENT -->
        <div class="flex-1 overflow-y-auto">
          <!-- DASHBOARD -->
          <div id="dashboardPage" class="page-content p-8">
            <div class="mb-6">
              <h1
                id="dashboardTitle"
                class="text-3xl font-bold text-gray-800 mb-2"
              >
                T·ªïng quan xe c·ªßa t√¥i
              </h1>
              <p id="welcomeMessage" class="text-gray-600">
                Theo d√µi t·ªëc ƒë·ªô v√† √°p su·∫•t l·ªëp theo th·ªùi gian th·ª±c
              </p>

              <div class="flex items-center mt-4 space-x-3">
                <label class="text-sm text-gray-700 font-semibold">
                  Xe ƒëang xem:
                </label>
                <select id="currentPlateSelect" class="form-input w-60"></select>
              </div>
              <div class="flex items-center mt-2">
                <span
                  class="w-3 h-3 bg-green-500 rounded-full pulse mr-2"
                ></span>
                <span class="text-sm text-gray-600"
                  >ƒêang k·∫øt n·ªëi v·ªõi h·ªá th·ªëng</span
                >
              </div>
            </div>

            <!-- STATS -->
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <div class="stat-card">
  <div class="flex items-center justify-between mb-2">
    <span class="text-gray-600 text-sm font-semibold">
      Xe ƒëang theo d√µi
    </span>
    <span class="text-2xl">üöó</span>
  </div>

  <!-- CH·ªñ N√ÄY HI·ªÇN BI·ªÇN S·ªê -->
  <div class="text-3xl font-bold text-gray-800" id="activeVehiclePlate">
    --
  </div>

  <div class="text-xs text-green-600 mt-1">
    Bi·ªÉn s·ªë
  </div>
</div>
              <div class="stat-card">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-gray-600 text-sm font-semibold"
                    >C·∫£nh b√°o</span
                  >
                  <span class="text-2xl">‚ö†Ô∏è</span>
                </div>
                <div class="text-3xl font-bold text-orange-600" id="alertCount">
                  0
                </div>
                <div class="text-xs text-orange-600 mt-1" id="alertStatus">
                  Kh√¥ng c√≥ c·∫£nh b√°o
                </div>
              </div>
              <div class="stat-card">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-gray-600 text-sm font-semibold"
                    >T·ªëc ƒë·ªô hi·ªán t·∫°i</span
                  >
                  <span class="text-2xl">‚ö°</span>
                </div>
                <div class="text-3xl font-bold text-blue-600" id="avgSpeed">
                  0
                </div>
                <div class="text-xs text-gray-500 mt-1">km/h</div>
              </div>
              <div class="stat-card">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-gray-600 text-sm font-semibold"
                    >√Åp su·∫•t l·ªëp</span
                  >
                  <span class="text-2xl">üîß</span>
                </div>
                <div
                  class="text-3xl font-bold text-purple-600"
                  id="avgPressure"
                >
                  0
                </div>
                <div class="text-xs text-gray-500 mt-1">bar</div>
              </div>
            </div>

            <!-- CHART + MAP -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <div class="chart-container">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                  Bi·ªÉu ƒë·ªì t·ªëc ƒë·ªô theo th·ªùi gian
                </h3>
                <div
                  id="speedChart"
                  class="h-64 flex items-center justify-center text-gray-400"
                >
                  D·ªØ li·ªáu s·∫Ω hi·ªÉn th·ªã khi c√≥ xe ho·∫°t ƒë·ªông
                </div>
              </div>
              <div class="chart-container">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                  Bi·ªÉu ƒë·ªì √°p su·∫•t l·ªëp
                </h3>
                <div
                  id="pressureChart"
                  class="h-64 flex items-center justify-center text-gray-400"
                >
                  D·ªØ li·ªáu s·∫Ω hi·ªÉn th·ªã khi c√≥ xe ho·∫°t ƒë·ªông
                </div>
              </div>
            </div>

            <div class="chart-container">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                V·ªã tr√≠ xe tr√™n b·∫£n ƒë·ªì
              </h3>
              <div
                id="vehicleMap"
                class="w-full rounded-lg"
                style="min-height: 320px"
              ></div>
            </div>
          </div>

          <!-- HISTORY PAGE -->
          <div id="historyPage" class="page-content p-8" style="display: none">
            <div class="mb-6">
              <h1 class="text-3xl font-bold text-gray-800 mb-2">L·ªãch s·ª≠</h1>
              <p class="text-gray-600">
                Xem l·∫°i d·ªØ li·ªáu t·ªëc ƒë·ªô v√† √°p su·∫•t theo th·ªùi gian
              </p>
            </div>
            <div class="chart-container mb-6">
              <h3 class="text-lg font-bold text-gray-800 mb-4">B·ªô l·ªçc</h3>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >Xe ƒëang xem</label
                  >
                  <div
                    id="historyCurrentPlate"
                    class="px-3 py-2 rounded-lg bg-gray-100 text-sm text-gray-700"
                  >
                    Ch∆∞a ch·ªçn xe
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >T·ª´ ng√†y</label
                  >
                  <input type="date" id="historyDateFrom" class="form-input" />
                </div>
                <div>
                  <label class="block text-sm font-semibold text-gray-700 mb-2"
                    >ƒê·∫øn ng√†y</label
                  >
                  <input type="date" id="historyDateTo" class="form-input" />
                </div>
              </div>
              <button id="applyHistoryFilter" class="btn-primary mt-4">
                √Åp d·ª•ng b·ªô l·ªçc
              </button>
            </div>
            <div class="chart-container">
              <h3 class="text-lg font-bold text-gray-800 mb-4">
                Bi·ªÉu ƒë·ªì l·ªãch s·ª≠
              </h3>
              <div
                id="historyChart"
                class="h-96 flex items-center justify-center text-gray-400"
              >
                Ch·ªçn kho·∫£ng th·ªùi gian v√† nh·∫•n "√Åp d·ª•ng" ƒë·ªÉ xem d·ªØ li·ªáu
              </div>
            </div>
          </div>

          <!-- ALERTS PAGE -->
          <div id="alertsPage" class="page-content p-8" style="display: none">
            <div class="mb-6">
              <h1 class="text-3xl font-bold text-gray-800 mb-2">C·∫£nh b√°o</h1>
              <p class="text-gray-600">
                C√°c c·∫£nh b√°o v·ªÅ t·ªëc ƒë·ªô v√† √°p su·∫•t l·ªëp c·ªßa xe ƒëang xem
              </p>
            </div>
            <div id="alertsList" class="space-y-4">
              <div class="text-center py-12 text-gray-400">
                Kh√¥ng c√≥ c·∫£nh b√°o n√†o
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* ===== C·∫§U H√åNH C∆† B·∫¢N ===== */
      const defaultConfig = {
        system_title: "H·ªá th·ªëng gi√°m s√°t ph∆∞∆°ng ti·ªán th√¥ng minh",
        dashboard_title: "T·ªïng quan h·ªá th·ªëng",
        welcome_message: "Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng gi√°m s√°t",
        primary_color: "#2563eb",
        secondary_color: "#1e3a8a",
        text_color: "#1f2937",
        background_color: "#f0f4f8",
        accent_color: "#ef4444",
      };

      const ACCOUNTS = [
        { username: "admin", password: "123456" },
        { username: "boss", password: "abcd1234" },
      ];

      let currentPage = "dashboard";
      let isLoggedIn = false;

      // Map
      let map;
      let vehicleMarker;
      let mapInitialized = false;

      // Telemetry
      let telemetryAll = [];
      let telemetryHistory = [];
      let alertsHistory = [];

      let selectedPlate = null;
      let availablePlates = [];
      let latestByPlate = {};

      // Charts
      let speedChart;
      let pressureChart;
      let historyChartInstance;
      let chartLabels = [];
      let chartSpeed = [];
      let chartPressure = [];
      const MAX_POINTS = 50;

      /* ===== INIT APP ===== */
      async function initApp() {
        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange: async (config) => {
              const systemTitle = document.getElementById("systemTitle");
              const dashboardTitle =
                document.getElementById("dashboardTitle");
              const welcomeMessage =
                document.getElementById("welcomeMessage");

              if (systemTitle)
                systemTitle.textContent =
                  config.system_title || defaultConfig.system_title;
              if (dashboardTitle)
                dashboardTitle.textContent =
                  config.dashboard_title || defaultConfig.dashboard_title;
              if (welcomeMessage)
                welcomeMessage.textContent =
                  config.welcome_message || defaultConfig.welcome_message;
            },
          });
        }

        setupEventListeners();
      }

      function initVehicleMap(initialLat = 21.0278, initialLng = 105.8342) {
        if (mapInitialized) return;
        map = L.map("vehicleMap").setView([initialLat, initialLng], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "¬© OpenStreetMap contributors",
        }).addTo(map);
        mapInitialized = true;
      }

      /* ===== LOAD DANH S√ÅCH BI·ªÇN S·ªê ===== */
      async function loadPlates() {
  try {
    const res = await fetch("/plates");
    if (!res.ok) return;
    const list = await res.json();
    if (!Array.isArray(list)) return;

    availablePlates = list;

    const select = document.getElementById("currentPlateSelect");
    const historyLabel = document.getElementById("historyCurrentPlate");
    const activeVehiclePlateEl = document.getElementById("activeVehiclePlate");

    if (select) {
      select.innerHTML = "";
      list.forEach((plate) => {
        const opt = document.createElement("option");
        opt.value = plate;
        opt.textContent = plate;
        select.appendChild(opt);
      });

      // auto ch·ªçn xe ƒë·∫ßu ti√™n n·∫øu ch∆∞a c√≥
      if (!selectedPlate && list.length > 0) {
        selectedPlate = list[0];
      }
      if (selectedPlate) {
        select.value = selectedPlate;
      }
    }

    // c·∫≠p nh·∫≠t label l·ªãch s·ª≠
    if (historyLabel) {
      historyLabel.textContent = selectedPlate || "Ch∆∞a ch·ªçn xe";
    }

    // üî• c·∫≠p nh·∫≠t lu√¥n card "Xe ƒëang theo d√µi"
    if (activeVehiclePlateEl) {
      activeVehiclePlateEl.textContent = selectedPlate || "--";
    }
  } catch (e) {
    console.error("[Plates] load error:", e);
  }
}


      /* ===== FORMAT TH·ªúI GIAN & CHART REALTIME ===== */
      function formatTimeLabel(ts) {
        const d = new Date(ts);
        return d.toLocaleTimeString("vi-VN", { hour12: false });
      }

      function initRealtimeCharts() {
        const speedDiv = document.getElementById("speedChart");
        const pressureDiv = document.getElementById("pressureChart");
        if (!speedDiv || !pressureDiv) return;

        if (speedChart) {
          speedChart.destroy();
          speedChart = null;
        }
        if (pressureChart) {
          pressureChart.destroy();
          pressureChart = null;
        }

        speedDiv.innerHTML = '<canvas id="speedChartCanvas"></canvas>';
        pressureDiv.innerHTML =
          '<canvas id="pressureChartCanvas"></canvas>';

        const ctxSpeed = document
          .getElementById("speedChartCanvas")
          .getContext("2d");
        const ctxPressure = document
          .getElementById("pressureChartCanvas")
          .getContext("2d");

        const samples = [...telemetryHistory]
          .sort(
            (a, b) =>
              new Date(a.timestamp) - new Date(b.timestamp)
          )
          .slice(-MAX_POINTS);

        chartLabels = samples.map((s) =>
          formatTimeLabel(s.timestamp || Date.now())
        );
        chartSpeed = samples.map((s) => s.speedKmh ?? 0);
        chartPressure = samples.map((s) => s.pressureBar ?? 0);

        speedChart = new Chart(ctxSpeed, {
          type: "line",
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: "T·ªëc ƒë·ªô (km/h)",
                data: chartSpeed,
                fill: false,
                tension: 0.2,
              },
            ],
          },
          options: {
            animation: false,
            responsive: true,
            scales: {
              x: { title: { display: true, text: "Th·ªùi gian" } },
              y: {
                beginAtZero: true,
                grace: "10%",
                title: { display: true, text: "T·ªëc ƒë·ªô (km/h)" },
              },
            },
          },
        });

        pressureChart = new Chart(ctxPressure, {
          type: "line",
          data: {
            labels: chartLabels,
            datasets: [
              {
                label: "√Åp su·∫•t (bar)",
                data: chartPressure,
                fill: false,
                tension: 0.2,
              },
            ],
          },
          options: {
            animation: false,
            responsive: true,
            scales: {
              x: { title: { display: true, text: "Th·ªùi gian" } },
              y: {
                min: 0,
                max: 3,
                title: { display: true, text: "√Åp su·∫•t (bar)" },
                ticks: { stepSize: 0.5 },
              },
            },
          },
        });
      }

      function pushTelemetryToCharts(sample) {
        if (!speedChart || !pressureChart) return;
        const label = formatTimeLabel(sample.timestamp || Date.now());
        const speed = sample.speedKmh ?? 0;
        const bar = sample.pressureBar ?? 0;

        chartLabels.push(label);
        chartSpeed.push(speed);
        chartPressure.push(bar);

        if (chartLabels.length > MAX_POINTS) {
          chartLabels.shift();
          chartSpeed.shift();
          chartPressure.shift();
        }

        speedChart.data.labels = chartLabels;
        speedChart.data.datasets[0].data = chartSpeed;
        speedChart.update("none");

        pressureChart.data.labels = chartLabels;
        pressureChart.data.datasets[0].data = chartPressure;
        pressureChart.update("none");
      }

      /* ===== L·ªäCH S·ª¨ ===== */
      async function loadInitialHistory() {
        try {
          const historyLabel =
            document.getElementById("historyCurrentPlate");
          if (historyLabel) {
            historyLabel.textContent =
              selectedPlate || "Ch∆∞a ch·ªçn xe";
          }

          if (!selectedPlate) {
            telemetryAll = [];
            telemetryHistory = [];
            alertsHistory = [];
            initRealtimeCharts();
            renderHistoryChart();
            updateAlertsList();
            return;
          }

          const params = new URLSearchParams({
            limit: "500",
            plate: selectedPlate,
          });

          const res = await fetch(`/history?${params.toString()}`);
          if (!res.ok) {
            initRealtimeCharts();
            return;
          }

          const list = await res.json();
          telemetryAll = Array.isArray(list) ? list : [];

          applyHistoryFilter(true);
          initRealtimeCharts();
        } catch (e) {
          console.error("[History] load error:", e);
          initRealtimeCharts();
        }
      }

      function renderHistoryChart() {
        const container = document.getElementById("historyChart");
        if (!container) return;

        if (!telemetryHistory.length) {
          container.innerHTML = `
            <div class="h-96 flex items-center justify-center text-gray-400">
              Ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠. H√£y ch·ªçn kho·∫£ng th·ªùi gian v√† nh·∫•n "√Åp d·ª•ng".
            </div>`;
          if (historyChartInstance) {
            historyChartInstance.destroy();
            historyChartInstance = null;
          }
          return;
        }

        const samples = [...telemetryHistory].sort(
          (a, b) =>
            new Date(a.timestamp || a.ts || 0) -
            new Date(b.timestamp || b.ts || 0)
        );

        const labels = samples.map((item) => {
          const t = new Date(item.timestamp || item.ts || Date.now());
          return t.toLocaleString("vi-VN", { hour12: false });
        });

        const speedData = samples.map((item) => item.speedKmh ?? 0);
        const pressureData = samples.map((item) => item.pressureBar ?? 0);

        container.innerHTML = `<canvas id="historyChartCanvas"></canvas>`;
        const ctx = document
          .getElementById("historyChartCanvas")
          .getContext("2d");

        if (historyChartInstance) {
          historyChartInstance.destroy();
        }

        historyChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "T·ªëc ƒë·ªô (km/h)",
                data: speedData,
                yAxisID: "ySpeed",
                tension: 0.2,
                fill: false,
              },
              {
                label: "√Åp su·∫•t (bar)",
                data: pressureData,
                yAxisID: "yPressure",
                tension: 0.2,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            interaction: { mode: "index", intersect: false },
            scales: {
              x: {
                title: { display: true, text: "Th·ªùi gian" },
              },
              ySpeed: {
                type: "linear",
                position: "left",
                title: { display: true, text: "T·ªëc ƒë·ªô (km/h)" },
                min: 0,
                max: 120,
                ticks: { stepSize: 20 },
              },
              yPressure: {
                type: "linear",
                position: "right",
                title: { display: true, text: "√Åp su·∫•t (bar)" },
                min: 0,
                max: 3,
                ticks: { stepSize: 0.5 },
                grid: { drawOnChartArea: false },
              },
            },
          },
        });
      }

      function getLocalDateStr(ts) {
        const d = new Date(ts);
        if (isNaN(d)) return "";
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function applyHistoryFilter(initial = false) {
        if (!Array.isArray(telemetryAll)) telemetryAll = [];

        const fromInput = document.getElementById("historyDateFrom");
        const toInput = document.getElementById("historyDateTo");

        const fromVal = fromInput && fromInput.value ? fromInput.value : "";
        const toVal = toInput && toInput.value ? toInput.value : "";

        let filtered = telemetryAll.filter((item) => {
          const ts = item.timestamp || item.ts || Date.now();
          const day = getLocalDateStr(ts);
          if (!day) return false;
          if (fromVal && day < fromVal) return false;
          if (toVal && day > toVal) return false;
          if (selectedPlate && item.licensePlate) {
            return item.licensePlate === selectedPlate;
          }
          return true;
        });

        filtered.sort(
          (a, b) =>
            new Date(a.timestamp || a.ts || 0) -
            new Date(b.timestamp || b.ts || 0)
        );

        if (filtered.length > MAX_POINTS) {
          filtered = filtered.slice(filtered.length - MAX_POINTS);
        }

        telemetryHistory = filtered;

        // rebuild alerts list t·ª´ l·ªãch s·ª≠
        alertsHistory = telemetryHistory.filter(
          (s) => s.overMax || s.underMin
        );
        updateAlertsList();

        renderHistoryChart();

        if (!initial && telemetryHistory.length === 0) {
          showToast(
            "Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn",
            "error"
          );
        }
      }

      /* ===== WEBSOCKET ===== */
      function connectDashboardWS() {
        const loc = window.location;
        const proto = loc.protocol === "https:" ? "wss" : "ws";
        const wsUrl = `${proto}://${loc.host}/ws`;

        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          ws.send(JSON.stringify({ type: "dashboard_subscribe" }));
          console.log("[WS] Dashboard connected");
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);

            if (data.type === "telemetry_update") {
              if (data.licensePlate) {
                latestByPlate[data.licensePlate] = data;
              }

              if (
                selectedPlate &&
                data.licensePlate &&
                data.licensePlate !== selectedPlate
              ) {
                return;
              }

              telemetryAll.push(data);
              updateRealtimeFromTelemetry(data);
              applyHistoryFilter(false);

              if (data.overMax || data.underMin) {
                alertsHistory.push(data);
                if (alertsHistory.length > 100) alertsHistory.shift();
                updateAlertsList();
              }
            }
          } catch (e) {
            console.error("[WS] parse error:", e);
          }
        };

        ws.onerror = (err) => {
          console.error("[WS] error:", err);
        };

        ws.onclose = () => {
          console.warn("[WS] closed");
        };
      }

      /* ===== UPDATE DASHBOARD T·ª™ 1 M·∫™U ===== */
      function updateRealtimeFromTelemetry(item) {
        if (!speedChart || !pressureChart) {
          initRealtimeCharts();
        }

        pushTelemetryToCharts(item);

        const speed = item.speedKmh ?? 0;
        const bar = item.pressureBar ?? 0;

        const avgSpeedEl = document.getElementById("avgSpeed");
        const avgPressureEl = document.getElementById("avgPressure");
        const activeVehiclePlateEl = document.getElementById("activeVehiclePlate");
        const alertCountEl = document.getElementById("alertCount");
        const alertStatusEl = document.getElementById("alertStatus");

        if (avgSpeedEl) avgSpeedEl.textContent = speed.toFixed(1);
        if (avgPressureEl) avgPressureEl.textContent = bar.toFixed(2);

        if (activeVehiclePlateEl) {
  // ∆∞u ti√™n bi·ªÉn s·ªë ƒëang ch·ªçn, fallback sang bi·ªÉn trong g√≥i tin
  activeVehiclePlateEl.textContent =
    selectedPlate || item.licensePlate || "--";
}

        const hasAlert = item.overMax || item.underMin;
        if (alertCountEl) alertCountEl.textContent = hasAlert ? "1" : "0";

        if (alertStatusEl) {
          if (hasAlert) {
            alertStatusEl.textContent = "C√≥ c·∫£nh b√°o";
            alertStatusEl.className =
              "text-xs text-orange-600 mt-1";
          } else {
            alertStatusEl.textContent = "Kh√¥ng c√≥ c·∫£nh b√°o";
            alertStatusEl.className =
              "text-xs text-green-600 mt-1";
          }
        }

        const lat = typeof item.lat === "number" ? item.lat : null;
        const lng = typeof item.lng === "number" ? item.lng : null;

        if (lat != null && lng != null) {
          if (!mapInitialized) {
            initVehicleMap(lat, lng);
          }
          const pos = [lat, lng];
          if (!vehicleMarker) {
            vehicleMarker = L.marker(pos).addTo(map);
            vehicleMarker.bindPopup("V·ªã tr√≠ hi·ªán t·∫°i c·ªßa xe");
          } else {
            vehicleMarker.setLatLng(pos);
          }
          map.setView(pos, map.getZoom() || 14);
        }
      }

      /* ===== ALERTS UI ===== */
      function updateAlertsList() {
        const listEl = document.getElementById("alertsList");
        if (!listEl) return;

        if (!alertsHistory.length) {
          listEl.innerHTML = `
            <div class="text-center py-12 text-gray-400">
              Kh√¥ng c√≥ c·∫£nh b√°o n√†o
            </div>`;
          return;
        }

        const items = alertsHistory
          .slice()
          .reverse()
          .map((a) => {
            const t = new Date(a.timestamp || a.ts || Date.now());
            const timeStr = t.toLocaleString("vi-VN", {
              hour12: false,
            });
            const reason = a.overMax
              ? "V∆∞·ª£t qu√° t·ªëc ƒë·ªô cho ph√©p"
              : "Ch∆∞a ƒë·∫°t t·ªëc ƒë·ªô t·ªëi thi·ªÉu";

            return `
              <div class="alert-item">
                <div class="flex justify-between items-center mb-1">
                  <div class="font-semibold text-red-600">${reason}</div>
                  <div class="text-xs text-gray-500">${timeStr}</div>
                </div>
                <div class="text-sm text-gray-700">
                  Bi·ªÉn s·ªë: <span class="font-semibold">${
                    a.licensePlate || "N/A"
                  }</span>
                  ‚Ä¢ T·ªëc ƒë·ªô: <span class="font-semibold">${
                    a.speedKmh ?? 0
                  } km/h</span>
                  ‚Ä¢ Gi·ªõi h·∫°n: <span class="font-semibold">${
                    a.limitKmh ?? "?"}</span>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                  √Åp su·∫•t: ${(a.pressureBar ?? 0).toFixed(2)} bar ‚Ä¢ ƒê∆∞·ªùng: ${
              a.highway || "kh√¥ng r√µ"
            }
                </div>
              </div>`;
          })
          .join("");

        listEl.innerHTML = items;
      }

      /* ===== UI CHUNG ===== */
      function setupEventListeners() {
        const loginForm = document.getElementById("loginForm");
        if (loginForm) {
          loginForm.addEventListener("submit", (e) => {
            e.preventDefault();
            login();
          });
        }

        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", logout);
        }

        document.querySelectorAll(".nav-item").forEach((item) => {
          item.addEventListener("click", () => {
            const page = item.dataset.page;
            navigateToPage(page);
          });
        });

        const applyHistoryFilterBtn =
          document.getElementById("applyHistoryFilter");
        if (applyHistoryFilterBtn) {
          applyHistoryFilterBtn.addEventListener("click", () =>
            applyHistoryFilter(false)
          );
        }

        const plateSelect =
          document.getElementById("currentPlateSelect");
        if (plateSelect) {
          plateSelect.addEventListener("change", async (e) => {
            selectedPlate = e.target.value || null;
            const historyLabel =
              document.getElementById("historyCurrentPlate");
            if (historyLabel) {
              historyLabel.textContent =
                selectedPlate || "Ch∆∞a ch·ªçn xe";
            }
            const activeVehiclePlateEl = document.getElementById("activeVehiclePlate");
  if (activeVehiclePlateEl) {
    activeVehiclePlateEl.textContent = selectedPlate || "--";
  }

            telemetryAll = [];
            telemetryHistory = [];
            alertsHistory = [];
            initRealtimeCharts();
            renderHistoryChart();
            updateAlertsList();

            await loadInitialHistory();

            if (selectedPlate && latestByPlate[selectedPlate]) {
              updateRealtimeFromTelemetry(
                latestByPlate[selectedPlate]
              );
            }
          });
        }
      }

      async function login() {
        const username = document
          .getElementById("loginUsername")
          .value.trim();
        const passInput = document
          .getElementById("loginPassword")
          .value.trim();

        const user = ACCOUNTS.find(
          (u) => u.username === username && u.password === passInput
        );

        if (!user) {
          showToast("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!", "error");
          return;
        }

        isLoggedIn = true;
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainApp").style.display = "block";

        showToast(`ƒêƒÉng nh·∫≠p th√†nh c√¥ng: ${username}`, "success");

        await loadPlates();
        await loadInitialHistory();

        setTimeout(() => {
          initVehicleMap();
        }, 0);

        connectDashboardWS();
      }

      function logout() {
        isLoggedIn = false;
        document.getElementById("loginPage").style.display = "flex";
        document.getElementById("mainApp").style.display = "none";
      }

      function navigateToPage(page) {
        document
          .querySelectorAll(".page-content")
          .forEach((p) => (p.style.display = "none"));
        document
          .querySelectorAll(".nav-item")
          .forEach((item) => item.classList.remove("active"));

        const pageElement = document.getElementById(page + "Page");
        if (pageElement) pageElement.style.display = "block";

        const navItem = document.querySelector(
          `.nav-item[data-page="${page}"]`
        );
        if (navItem) navItem.classList.add("active");

        currentPage = page;
      }

      function showToast(message, type = "success") {
        const toast = document.createElement("div");
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 ${
          type === "success" ? "bg-green-500" : "bg-red-500"
        }`;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transition = "opacity 0.3s ease";
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 3000);
      }

      initApp();
    </script>

    <!-- Cloudflare script gi·ªØ nguy√™n (n·∫øu c√≥) -->
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement("script");
            d.innerHTML =
              "window.__CF$cv$params={r:'99d43c74339ea909',t:'MTc2MjkzMTcwNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName("head")[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement("iframe");
          a.height = 1;
          a.width = 1;
          a.style.position = "absolute";
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = "none";
          a.style.visibility = "hidden";
          document.body.appendChild(a);
          if ("loading" !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener("DOMContentLoaded", c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              "loading" !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
